<!DOCTYPE html>
<html>
<head>
    <title>回译校对工具 v2.8 (含内容更新)</title>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            position: relative;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 800px;
            max-width: 100%;
            text-align: center;
        }

        h2 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .main-actions {
            position: absolute;
            top: 25px;
            right: 30px;
            display: flex;
            gap: 10px;
        }
        
        #manageCoursesBtn {
            background-color: #6c757d;
            font-size: 14px;
            padding: 8px 15px;
        }
        #manageCoursesBtn:hover {
            background-color: #5a6268;
        }

        #importBtn, #exportBtn {
             background-color: #17a2b8;
             color: white;
             font-size: 14px;
             padding: 8px 15px;
        }
        #importBtn:hover, #exportBtn:hover {
            background-color: #138496;
        }


        #courseSelectorContainer {
            margin-bottom: 30px;
            text-align: left;
        }
        .course-selector {
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .course-selector summary {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            background-color: #f7f7f7;
            list-style: none;
        }
        .course-selector summary::-webkit-details-marker {
            display: none;
        }
        .course-selector summary::before {
            content: '▶';
            margin-right: 8px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        .course-selector[open] > summary::before {
            transform: rotate(90deg);
        }

        .course-filter-tabs {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .filter-tab {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .filter-tab:hover {
            background-color: #dbe2e8;
        }
        .filter-tab.active {
            background-color: #007BFF;
            color: #fff;
            border-color: #007BFF;
        }
        
        .course-list-wrapper {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #ddd;
        }
        .course-items-container {
             padding: 5px;
        }
        .course-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 3px;
        }
        .course-item:hover {
            background-color: #f0f0f0;
        }
        .course-item-actions {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .course-item .icon {
            color: #999;
            visibility: hidden;
            opacity: 0;
            transition: all 0.2s;
            cursor: pointer;
        }
        .course-item:hover .icon {
            visibility: visible;
            opacity: 1;
        }
        .course-item .icon.edit-icon:hover {
            color: #007BFF;
        }
        .course-item .icon.delete-icon:hover {
            color: #dc3545;
        }


        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: #fff; padding: 25px; border-radius: 8px;
            width: 600px; max-width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h3 { margin-top: 0; text-align: left; }
        .modal-content .form-group { margin-bottom: 15px; text-align: left; }
        .modal-content label { margin-bottom: 5px; }
        .modal-content input, .modal-content textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;
            font-size: 16px; box-sizing: border-box; font-family: 'Roboto', 'Noto Sans SC', sans-serif;
        }
        .modal-content textarea { height: 150px; resize: vertical; }
        .modal-buttons { text-align: right; margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; font-size: 16px; margin-left: 10px; }
        #modalCloseBtn { background-color: #6c757d; }
        #modalCloseBtn:hover { background-color: #5a6268; }

        #modalSaveAndNewBtn {
            background-color: #28a745;
        }
        #modalSaveAndNewBtn:hover {
            background-color: #218838;
        }
        #modalSaveAndNewBtn.saved {
            background-color: #1e7e34;
            cursor: not-allowed;
        }

        .textarea-group { margin-bottom: 20px; text-align: left; }
        .textarea-label-with-icon { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        label { display: block; font-weight: bold; color: #555; margin-bottom: 0; }
        
        /* --- 修改点：统一管理标题栏的图标样式 --- */
        .delete-all-icon, .upload-icon {
            font-size: 20px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }
        .delete-all-icon:hover { color: #dc3545; }
        .upload-icon:hover { color: #007BFF; } /* 新增上传图标的悬浮效果 */

        textarea {
            width: 100%; height: 250px; padding: 12px; border: 1px solid #ccc; border-radius: 4px;
            resize: vertical; font-size: 16px; box-sizing: border-box; font-family: 'Roboto', 'Noto Sans SC', sans-serif;
        }
        .edit-textarea { height: 80px; }
        .button-group { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
        button {
            background-color: #007BFF; color: #fff; border: none; padding: 12px 25px; border-radius: 4px;
            cursor: pointer; font-size: 18px; transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        #result { margin-top: 42px; text-align: left; line-height: 1.6; padding: 20px; border-radius: 4px; border: 1px solid #ddd; }
        .sentence-group { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px; position: relative; }
        .editable-sentence { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; position: relative; }
        .edit-icon, .submit-icon { font-size: 19.2px; color: #999; cursor: pointer; transition: color 0.3s; }
        .edit-icon:hover { color: #333; }
        .submit-icon { color: #28a745; cursor: pointer; font-size: 24px; }
        .edit-buttons { display: flex; align-items: center; gap: 24px; }
        .delete-single-icon { font-size: 20px; color: #999; cursor: pointer; transition: color 0.3s; }
        .delete-single-icon:hover { color: #dc3545; }
        .diff-word { background-color: #ffcccc; padding: 2px 4px; border-radius: 3px; font-weight: bold; }
        .result-title { font-weight: bold; color: #333; margin-bottom: 0; }
        .original-text, .translation-text, .chinese-translation { word-wrap: break-word; flex-grow: 1; margin-bottom: 20px; transition: filter 0.3s ease-in-out; white-space: pre-wrap; }
        .blurred { filter: blur(4px); pointer-events: none; user-select: none; }
        #backToTopBtn {
            display: none; position: fixed; bottom: 30px; right: 30px; z-index: 99; border: none; outline: none;
            background-color: #007BFF; color: white; cursor: pointer; padding: 15px; border-radius: 50%;
            font-size: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: background-color 0.3s, opacity 0.3s;
        }
        #backToTopBtn:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-actions">
            <button id="importBtn">导入课程</button>
            <button id="exportBtn">导出课程</button>
            <button id="manageCoursesBtn">新增课程</button>
        </div>
        <input type="file" id="importFileInput" accept=".json" style="display: none;">

        <h2>回译校对</h2>

        <div id="courseSelectorContainer">
            <details class="course-selector">
                <summary>选择课程</summary>
                <div class="course-list-wrapper">
                    <div class="course-filter-tabs" id="courseFilterTabs"></div>
                    <div class="course-items-container" id="courseItemsContainer"></div>
                </div>
            </details>
        </div>

        <div class="textarea-group">
            <div class="textarea-label-with-icon">
                <label for="originalText">英文原文：</label>
                <span class="material-symbols-outlined upload-icon" id="uploadOriginalTextBtn" title="更新课程原文">upload</span>
            </div>
            <textarea id="originalText" placeholder="在此输入英文原文，或从上方选择课程载入..."></textarea>
        </div>
        <div class="textarea-group">
            <div class="textarea-label-with-icon">
                <label for="translationText">译文：</label>
                <span class="material-symbols-outlined upload-icon" id="uploadTranslationTextBtn" title="更新课程译文">upload</span>
            </div>
            <textarea id="translationText" placeholder="在此输入你的中文译文，或从上方选择课程载入..."></textarea>
        </div>

        <div class="textarea-group">
            <div class="textarea-label-with-icon">
                <label for="myTranslation">我的回译版本：</label>
                <span class="material-symbols-outlined delete-all-icon" id="deleteAllMyTranslation">delete</span>
            </div>
            <textarea id="myTranslation" placeholder="在此输入你的回译版本..."></textarea>
        </div>
        <div class="button-group">
            <button id="proofreadBtn">校对</button>
        </div>
        <div id="result"></div>
    </div>

    <div class="modal-overlay" id="courseModal">
        <div class="modal-content">
            <h3 id="modalTitle">新增课程</h3>
            <div class="form-group">
                <label for="modalLessonName">课程名称</label>
                <input type="text" id="modalLessonName" placeholder="例如：Unit 1, Lesson 5">
            </div>
            <div class="form-group">
                <label for="modalOriginalText">英文原文</label>
                <textarea id="modalOriginalText"></textarea>
            </div>
            <div class="form-group">
                <label for="modalTranslationText">译文</label>
                <textarea id="modalTranslationText"></textarea>
            </div>
            <div class="modal-buttons">
                <button id="modalCloseBtn">取消</button>
                <button id="modalSaveBtn">保存</button>
                <button id="modalSaveAndNewBtn">保存并新增另一篇</button>
            </div>
        </div>
    </div>

    <button id="backToTopBtn">回到顶部</button>

    <script>
        // DOM 元素获取
        const originalTextArea = document.getElementById('originalText');
        const translationTextArea = document.getElementById('translationText');
        const myTranslationTextArea = document.getElementById('myTranslation');
        const proofreadBtn = document.getElementById('proofreadBtn');
        const deleteAllMyTranslationBtn = document.getElementById('deleteAllMyTranslation');
        const backToTopBtn = document.getElementById('backToTopBtn');
        const resultDiv = document.getElementById('result');
        const STORAGE_PREFIX = 'bt_tool_';

        const manageCoursesBtn = document.getElementById('manageCoursesBtn');
        const courseModal = document.getElementById('courseModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalSaveBtn = document.getElementById('modalSaveBtn');
        const modalSaveAndNewBtn = document.getElementById('modalSaveAndNewBtn');
        const modalTitle = document.getElementById('modalTitle');
        const modalLessonName = document.getElementById('modalLessonName');
        const modalOriginalText = document.getElementById('modalOriginalText');
        const modalTranslationText = document.getElementById('modalTranslationText');
        const courseItemsContainer = document.getElementById('courseItemsContainer');
        const courseFilterTabs = document.getElementById('courseFilterTabs');
        
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importFileInput = document.getElementById('importFileInput');
        
        // --- 新增点: 获取新添加的上传按钮 ---
        const uploadOriginalTextBtn = document.getElementById('uploadOriginalTextBtn');
        const uploadTranslationTextBtn = document.getElementById('uploadTranslationTextBtn');


        let allLessons = [];
        let modalMode = 'add'; 
        let originalLessonName = ''; 
        let currentLoadedLessonName = null; // --- 新增点: 用于跟踪当前加载的课程 ---

        // ==================== 导入/导出功能 ====================
        
        function handleExport() {
            const coursesToExport = {};
            let coursesFound = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX)) {
                    const lessonName = key.substring(STORAGE_PREFIX.length);
                    const lessonData = JSON.parse(localStorage.getItem(key));
                    coursesToExport[lessonName] = lessonData;
                    coursesFound++;
                }
            }

            if (coursesFound === 0) {
                alert('没有可导出的课程。');
                return;
            }

            const dataStr = JSON.stringify(coursesToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);

            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            const timestamp = new Date().toISOString().slice(0, 10);
            downloadLink.download = `back-translation-courses-${timestamp}.json`;

            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedCourses = JSON.parse(e.target.result);
                    let importedCount = 0;
                    let overwrittenCount = 0;

                    if (typeof importedCourses !== 'object' || importedCourses === null) {
                        throw new Error('无效的文件格式，文件内容必须是一个JSON对象。');
                    }
                    
                    if (Object.keys(importedCourses).length === 0) {
                        alert('文件为空或格式不正确，未导入任何课程。');
                        return;
                    }

                    if (confirm('导入操作将覆盖所有同名课程。\n您确定要继续吗？')) {
                        for (const lessonName in importedCourses) {
                            if (Object.prototype.hasOwnProperty.call(importedCourses, lessonName)) {
                                const lessonData = importedCourses[lessonName];
                                if (lessonData && typeof lessonData.original === 'string' && typeof lessonData.translation === 'string') {
                                    const key = STORAGE_PREFIX + lessonName;
                                    if (localStorage.getItem(key)) {
                                        overwrittenCount++;
                                    } else {
                                        importedCount++;
                                    }
                                    localStorage.setItem(key, JSON.stringify(lessonData));
                                } else {
                                    console.warn(`跳过无效的课程数据: ${lessonName}`);
                                }
                            }
                        }

                        refreshCourseList();
                        alert(`导入完成！\n\n新增课程: ${importedCount}\n覆盖课程: ${overwrittenCount}`);
                    }
                } catch (error) {
                    alert('导入失败！请确保您上传的是一个有效的课程JSON文件。\n错误信息: ' + error.message);
                } finally {
                    event.target.value = null;
                }
            };
            reader.onerror = function() {
                alert('读取文件时出错。');
                event.target.value = null;
            };
            reader.readAsText(file);
        }
        
        importBtn.addEventListener('click', () => importFileInput.click());
        exportBtn.addEventListener('click', handleExport);
        importFileInput.addEventListener('change', handleFileSelect);


        // ==================== 弹窗 (Modal) 控制逻辑 ====================
        
        function setupAndOpenModal(mode, lessonNameToEdit = null) {
            modalMode = mode;
            if (mode === 'edit') {
                const lessonData = JSON.parse(localStorage.getItem(STORAGE_PREFIX + lessonNameToEdit));
                if (!lessonData) return;

                originalLessonName = lessonNameToEdit;
                modalTitle.textContent = '编辑课程';
                modalLessonName.value = lessonNameToEdit;
                modalOriginalText.value = lessonData.original;
                modalTranslationText.value = lessonData.translation;
                modalSaveAndNewBtn.style.display = 'none';
            } else { // 'add' mode
                originalLessonName = '';
                modalTitle.textContent = '新增课程';
                clearModalInputs();
                modalSaveAndNewBtn.style.display = 'inline-block';
            }
            courseModal.style.display = 'flex';
        }

        function closeModal() {
            courseModal.style.display = 'none';
        }

        function clearModalInputs() {
            modalLessonName.value = '';
            modalOriginalText.value = '';
            modalTranslationText.value = '';
            modalLessonName.focus();
        }
        
        manageCoursesBtn.addEventListener('click', () => setupAndOpenModal('add'));
        modalCloseBtn.addEventListener('click', closeModal);
        courseModal.addEventListener('click', (e) => (e.target === courseModal) && closeModal());


        // ==================== 课程库核心逻辑 ====================

        // --- 新增点: 更新课程内容的功能函数 ---
        function updateLessonContent(type) {
            if (!currentLoadedLessonName) {
                alert('请先从课程列表中选择一门课程，然后再执行更新操作。');
                return;
            }

            const lessonKey = STORAGE_PREFIX + currentLoadedLessonName;
            const lessonDataString = localStorage.getItem(lessonKey);

            if (!lessonDataString) {
                alert(`错误：在本地存储中找不到课程 "${currentLoadedLessonName}"。`);
                return;
            }

            const contentType = type === 'original' ? '原文' : '译文';
            if (!confirm(`您确定要用当前文本框中的内容覆盖课程 "${currentLoadedLessonName}" 的${contentType}吗？`)) {
                return;
            }

            try {
                const lessonData = JSON.parse(lessonDataString);

                if (type === 'original') {
                    lessonData.original = originalTextArea.value;
                } else if (type === 'translation') {
                    lessonData.translation = translationTextArea.value;
                }

                localStorage.setItem(lessonKey, JSON.stringify(lessonData));
                alert(`课程 "${currentLoadedLessonName}" 的${contentType}已成功更新！`);

            } catch (error) {
                alert('更新课程时发生错误: ' + error.message);
            }
        }
        
        function handleSave() {
            const newLessonName = modalLessonName.value.trim();
            const originalContent = modalOriginalText.value.trim();
            const translationContent = modalTranslationText.value.trim();

            if (!newLessonName || !originalContent || !translationContent) {
                alert('请确保课程的“名称”、“原文”和“译文”都已填写！');
                return;
            }

            const lessonData = { original: originalContent, translation: translationContent };

            if (modalMode === 'edit' && originalLessonName !== newLessonName) {
                localStorage.removeItem(STORAGE_PREFIX + originalLessonName);
            }

            localStorage.setItem(STORAGE_PREFIX + newLessonName, JSON.stringify(lessonData));
            alert(`课程 "${newLessonName}" 已成功保存！`);
            
            refreshCourseList();
            closeModal();
        }
        
        function handleSaveAndNew() {
            const lessonName = modalLessonName.value.trim();
            const originalContent = modalOriginalText.value.trim();
            const translationContent = modalTranslationText.value.trim();

             if (!lessonName || !originalContent || !translationContent) {
                alert('请确保课程的“名称”、“原文”和“译文”都已填写！');
                return;
            }

            const lessonData = { original: originalContent, translation: translationContent };
            localStorage.setItem(STORAGE_PREFIX + lessonName, JSON.stringify(lessonData));
            refreshCourseList();

            clearModalInputs();
            const originalText = modalSaveAndNewBtn.textContent;
            modalSaveAndNewBtn.textContent = '已保存!';
            modalSaveAndNewBtn.classList.add('saved');
            modalSaveAndNewBtn.disabled = true;

            setTimeout(() => {
                modalSaveAndNewBtn.textContent = originalText;
                modalSaveAndNewBtn.classList.remove('saved');
                modalSaveAndNewBtn.disabled = false;
            }, 1500);
        }

        function customNaturalSort(a, b) {
            const regex = /(\d+)/;
            const matchA = a.match(regex);
            const matchB = b.match(regex);
            if (matchA && matchB) {
                const numA = parseInt(matchA[1], 10);
                const numB = parseInt(matchB[1], 10);
                if (numA !== numB) {
                    return numA - numB;
                }
            }
            return a.localeCompare(b);
        }

        function refreshCourseList() {
            allLessons = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX)) {
                    allLessons.push(key.substring(STORAGE_PREFIX.length));
                }
            }
            
            allLessons.sort(customNaturalSort);
            renderFilterTabs();
            renderCourseItems(allLessons);
            const firstTab = courseFilterTabs.querySelector('.filter-tab');
            if(firstTab) firstTab.classList.add('active');
        }
        
        function renderFilterTabs() {
            courseFilterTabs.innerHTML = '';
            if (allLessons.length === 0) return;

            const createTab = (text, isAll = false, start = 0, end = 0) => {
                const tab = document.createElement('button');
                tab.className = 'filter-tab';
                tab.textContent = text;
                if (isAll) { tab.dataset.all = 'true'; } 
                else { tab.dataset.start = start; tab.dataset.end = end; }
                return tab;
            };

            const allTab = createTab('全部', true);
            courseFilterTabs.appendChild(allTab);

            const groupSize = 10;
            for (let i = 0; i < allLessons.length; i += groupSize) {
                const start = i + 1;
                const end = Math.min(i + groupSize, allLessons.length);
                const tab = createTab(`${start}-${end}`, false, i, end - 1);
                courseFilterTabs.appendChild(tab);
            }
        }

        function renderCourseItems(lessonsToRender) {
            courseItemsContainer.innerHTML = '';
            if (lessonsToRender.length === 0) {
                 courseItemsContainer.innerHTML = '<div style="padding: 10px; color: #999;">无课程</div>';
                 return;
            }

            lessonsToRender.forEach(lessonName => {
                const item = document.createElement('div');
                item.className = 'course-item';
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('icon')) return;
                    loadLesson(lessonName);
                });
                
                item.innerHTML = `
                    <span class="lesson-name">${lessonName}</span>
                    <div class="course-item-actions">
                        <span class="material-symbols-outlined icon edit-icon" data-lesson-name="${lessonName}">edit</span>
                        <span class="material-symbols-outlined icon delete-icon" data-lesson-name="${lessonName}">delete</span>
                    </div>
                `;
                courseItemsContainer.appendChild(item);
            });
        }

        function loadLesson(lessonName) {
            const lessonDataString = localStorage.getItem(STORAGE_PREFIX + lessonName);
            if (lessonDataString) {
                const lessonData = JSON.parse(lessonDataString);
                originalTextArea.value = lessonData.original;
                translationTextArea.value = lessonData.translation;
                myTranslationTextArea.value = '';
                resultDiv.innerHTML = '';
                currentLoadedLessonName = lessonName; // --- 修改点: 加载课程时，记录下课程名称 ---
                document.querySelector('.course-selector').removeAttribute('open');
            }
        }

        function deleteLesson(lessonName) {
            if (confirm(`您确定要删除课程 "${lessonName}" 吗？此操作不可恢复。`)) {
                localStorage.removeItem(STORAGE_PREFIX + lessonName);
                alert(`课程 "${lessonName}" 已被删除。`);
                // 如果删除的是当前加载的课程，则清空状态
                if(currentLoadedLessonName === lessonName) {
                    currentLoadedLessonName = null;
                    originalTextArea.value = '';
                    translationTextArea.value = '';
                }
                refreshCourseList();
            }
        }
        
        // --- 新增点: 为新按钮绑定点击事件 ---
        uploadOriginalTextBtn.addEventListener('click', () => updateLessonContent('original'));
        uploadTranslationTextBtn.addEventListener('click', () => updateLessonContent('translation'));

        modalSaveBtn.addEventListener('click', handleSave);
        modalSaveAndNewBtn.addEventListener('click', handleSaveAndNew);
        
        courseFilterTabs.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-tab')) {
                courseFilterTabs.querySelector('.active')?.classList.remove('active');
                e.target.classList.add('active');
                let lessonsToShow;
                if (e.target.dataset.all) { lessonsToShow = allLessons; } 
                else {
                    const start = parseInt(e.target.dataset.start);
                    const end = parseInt(e.target.dataset.end);
                    lessonsToShow = allLessons.slice(start, end + 1);
                }
                renderCourseItems(lessonsToShow);
            }
        });
        
        courseItemsContainer.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('icon')) {
                const lessonName = target.dataset.lessonName;
                if (target.classList.contains('edit-icon')) {
                    setupAndOpenModal('edit', lessonName);
                } else if (target.classList.contains('delete-icon')) {
                    deleteLesson(lessonName);
                }
            }
        });

        // ==================== 原有功能：校对逻辑 (无改动) ====================
        proofreadBtn.addEventListener('click', function() {
            try {
                originalTextArea.dataset.originalContent = originalTextArea.value;
                myTranslationTextArea.dataset.originalContent = myTranslationTextArea.value;
                translationTextArea.dataset.originalContent = translationTextArea.value;
                runProofreading();
            } catch (e) { console.error('An error occurred during proofreading:', e); alert('校对时发生错误，请检查您的输入。错误信息：' + e.message); }
        });
        deleteAllMyTranslationBtn.addEventListener('click', function() {
            myTranslationTextArea.value = '';
            myTranslationTextArea.dataset.originalContent = '';
        });
        function runProofreading() {
            const originalText = originalTextArea.value.trim(); const myTranslation = myTranslationTextArea.value.trim(); const translationText = translationTextArea.value.trim();
            if (!originalText || !myTranslation) { resultDiv.innerHTML = '请在英文原文和回译文本框中都输入内容。'; return; }
            const originalSentences = splitSentences(originalText); const mySentences = splitSentences(myTranslation); const chineseSentences = splitChineseSentences(translationText);
            let fullResultHTML = ''; const maxLength = Math.max(originalSentences.length, mySentences.length, chineseSentences.length);
            for (let i = 0; i < maxLength; i++) {
                const originalSentence = originalSentences[i] || ''; const mySentence = mySentences[i] || ''; const chineseSentence = chineseSentences[i] || '';
                const originalWords = originalSentence.split(/\s+/).filter(word => word.length > 0); const myWords = mySentence.split(/\s+/).filter(word => word.length > 0);
                let originalSentenceHTML = ''; let mySentenceHTML = ''; const minLength = Math.min(originalWords.length, myWords.length);
                let j = 0;
                for(j = 0; j < minLength; j++){
                    if (normalizeWord(originalWords[j]) === normalizeWord(myWords[j])) { originalSentenceHTML += `${originalWords[j]} `; mySentenceHTML += `${myWords[j]} `; } 
                    else { originalSentenceHTML += `<span class="diff-word">${originalWords[j]}</span> `; mySentenceHTML += `<span class="diff-word">${myWords[j]}</span> `; }
                }
                if (originalWords.length > myWords.length) { for (; j < originalWords.length; j++) { originalSentenceHTML += `<span class="diff-word">${originalWords[j]}</span> `; } } 
                else if (myWords.length > originalWords.length) { for (; j < myWords.length; j++) { mySentenceHTML += `<span class="diff-word">${myWords[j]}</span> `; } }
                fullResultHTML += `<div class="sentence-group" data-index="${i}"><div class="editable-sentence"><div class="result-title">原文句 ${i + 1}:</div><span class="material-symbols-outlined edit-icon" data-type="original">edit</span></div><div class="original-text">${originalSentenceHTML.trim()}</div><div class="editable-sentence"><div class="result-title">回译句 ${i + 1}:</div><span class="material-symbols-outlined edit-icon" data-type="myTranslation">edit</span></div><div class="translation-text">${mySentenceHTML.trim()}</div><div class="editable-sentence"><div class="result-title">中文译文句 ${i + 1}:</div><span class="material-symbols-outlined edit-icon" data-type="chinese">edit</span></div><div class="chinese-translation">${chineseSentence}</div></div>`;
            }
            resultDiv.innerHTML = fullResultHTML; attachEditEventListeners();
        }
        function attachEditEventListeners() {
            document.querySelectorAll('.edit-icon').forEach(icon => {
                icon.addEventListener('click', function(e) {
                    const sentenceGroup = e.target.closest('.sentence-group'); const index = parseInt(sentenceGroup.dataset.index); const type = e.target.dataset.type;
                    const textElem = sentenceGroup.querySelector(`.${type === 'original' ? 'original-text' : type === 'myTranslation' ? 'translation-text' : 'chinese-translation'}`);
                    const originalTextElement = sentenceGroup.querySelector('.original-text'); const myTranslationTextElement = sentenceGroup.querySelector('.translation-text');
                    const currentContent = textElem.textContent; textElem.innerHTML = `<textarea class="edit-textarea">${currentContent}</textarea>`;
                    const editButtons = document.createElement('div'); editButtons.className = 'edit-buttons'; editButtons.innerHTML = `<span class="material-symbols-outlined delete-single-icon" data-type="${type}">delete</span><span class="material-symbols-outlined submit-icon" data-type="${type}">done</span>`;
                    const deleteIcon = editButtons.querySelector('.delete-single-icon');
                    deleteIcon.addEventListener('click', function() { const textArea = editButtons.closest('.editable-sentence').nextElementSibling.querySelector('.edit-textarea'); if (textArea) { textArea.value = ''; } });
                    const submitIcon = editButtons.querySelector('.submit-icon');
                    submitIcon.addEventListener('click', function() {
                        const newText = textElem.querySelector('.edit-textarea').value; updateMainText(type, index, newText);
                        const editIcon = document.createElement('span'); editIcon.className = 'material-symbols-outlined edit-icon'; editIcon.textContent = 'edit'; editIcon.dataset.type = type;
                        editButtons.replaceWith(editIcon); originalTextElement.classList.remove('blurred'); myTranslationTextElement.classList.remove('blurred'); runProofreading();
                    });
                    e.target.replaceWith(editButtons);
                    if (type === 'myTranslation') { originalTextElement.classList.add('blurred'); } else if (type === 'original') { myTranslationTextElement.classList.add('blurred'); }
                });
            });
        }
        function updateMainText(type, index, newText) {
            let textArea; let sentences; let separator = '\n'; 
            if (type === 'original') { textArea = document.getElementById('originalText'); sentences = splitSentences(textArea.dataset.originalContent); }
            else if (type === 'myTranslation') { textArea = document.getElementById('myTranslation'); sentences = splitSentences(textArea.dataset.originalContent); }
            else if (type === 'chinese') { textArea = document.getElementById('translationText'); sentences = splitChineseSentences(textArea.dataset.originalContent); }
            sentences[index] = newText; textArea.value = sentences.join(separator); textArea.dataset.originalContent = textArea.value;
        }
        function normalizeWord(word) { return word.replace(/['"‘’“”]/g, '').toLowerCase(); }
        function splitSentences(text) {
            const lines = text.split('\n'); let sentences = []; const exceptions = [".'", '."', "?’", '?"', "?'", "!'", '!"', "Mr.", "Mrs.", "Doc.", "Dr."]; const punct_to_split = ['.', '?', '!'];
            lines.forEach(line => {
                let currentSentence = ''; let i = 0;
                while (i < line.length) {
                    let handled = false; for (const exception of exceptions) { if (line.substring(i, i + exception.length) === exception) { currentSentence += exception; i += exception.length; handled = true; break; } }
                    if (handled) continue;
                    const char = line[i]; currentSentence += char; const nextChar = line[i + 1];
                    if (punct_to_split.includes(char)) { if ((char === '.' && (nextChar === ' ' || nextChar === undefined)) || (['?', '!'].includes(char) && (nextChar === ' ' || nextChar === undefined))) { sentences.push(currentSentence.trim()); currentSentence = ''; } }
                    i++;
                }
                if (currentSentence.trim()) { sentences.push(currentSentence.trim()); }
            });
            return sentences.filter(s => s.length > 0);
        }
        function splitChineseSentences(text) {
            const lines = text.split('\n'); let sentences = []; const exceptions = ['。”', '？”', '！”', '！’']; const punct_to_split = ['。', '？', '！', '…'];
            lines.forEach(line => {
                let currentSentence = ''; let i = 0;
                while (i < line.length) {
                    let handled = false; for (const exception of exceptions) { if (line.substring(i, i + exception.length) === exception) { currentSentence += exception; i += exception.length; handled = true; break; } }
                    if (handled) continue;
                    const char = line[i]; currentSentence += char; if (punct_to_split.includes(char)) { sentences.push(currentSentence.trim()); currentSentence = ''; } i++;
                }
                if (currentSentence.trim()) { sentences.push(currentSentence.trim()); }
            });
            return sentences.filter(s => s.length > 0);
        }
        
        // ==================== 页面滚动与初始化 ====================
        window.onscroll = function() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) { backToTopBtn.style.display = "block"; } 
            else { backToTopBtn.style.display = "none"; }
        };
        backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        document.addEventListener('DOMContentLoaded', refreshCourseList);

    </script>
</body>
</html>